# Feature Specification: RPG/CL Development Support Tool for VS Code

**Feature Branch**: `001-rpg-cl-vscode-support`  
**Created**: 2025-11-15  
**Status**: Draft  
**Input**: User description: 「VS Code の拡張機能として、AS400 の RPG・CL コードを開発するための支援ツールを作成する。RPG は ILE RPG の固定長フォーマットのみ対象（フリーフォーマットは対象外）とする。」

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Edit existing RPG/CL code in VS Code (Priority: P1)

AS400 / IBM i 向けの RPG および CL で既存のソースコードを扱う開発者として、  
VS Code 上で固定長フォーマットの RPG と CL ソースを開き、列位置を意識しながら読み書きでき、  
視認性の高い表示と基本的な構文支援を受けたい。  
これにより、従来のグリーンスクリーンエディタに依存せず、モダンなエディタで日常的な開発作業を行えるようにしたい。
なお、視認性の高い表示とは、シフトアウト・シフトイン文字を `{` および `}` として表示する機能のことを指し、キーワードによる色分け表示や列位置ガイドの表示はCode for IBM iで提供されている為、実装は対象外とする。

**Why this priority**:  
既存コードの閲覧・軽微な修正が最も頻度の高い作業であり、ここが快適になることが開発者体験の改善と導入効果に直結するため。

**Independent Test**:  
パイロットユーザーが既存の RPG または CL ソースファイルを VS Code で開き、  
問題なく数行の変更と保存を完了できるかを確認する。

**Acceptance Scenarios**:

1. **Given** 開発者が固定長フォーマットの RPG ソースファイルを VS Code で開いている  
   **When** ファイルが RPG ソースとして認識される  
   **Then** シフトアウト・シフトイン文字が `{` および `}` として表示される

2. **Given** 開発者が CL ソースファイルを VS Code で開いている  
   **When** ファイルが CL ソースとして認識される  
   **Then** シフトアウト・シフトイン文字が `{` および `}` として表示される

---

---

### User Story 3 - Align local editing with AS400 workflows (Priority: P3)

ソースの編集・保存・生成・F4 プロンプターによるパラメータ入力などの「ローカル編集支援」のみを行い、  
AS400 への送信やコンパイル、デバッグ実行といったリモート操作は行わない。

**Why this priority**:  
ローカル編集体験の一貫性と生産性を高めることに集中するため。

**Independent Test**:  
パイロットユーザーが VS Code 上で RPG/CL ソースを編集・保存し、  
AS400 上の既存の運用フロー（コンパイルやデプロイ）はこれまでどおりの手順で実施してもらったときに、  
「エディタが変わっても日常の運用は乱れず、編集作業だけが楽になった」と評価されるかどうかを確認する。

**Acceptance Scenarios**:

1. **Given** AS400 上で運用されている RPG/CL プログラムのソースがローカルに取得されている  
   **When** 開発者が VS Code でソースを編集・保存する  
   **Then** 従来の運用手順（コンパイル・配置など）を変えなくても、編集作業そのものが VS Code 上で一貫して行える。

2. **Given** 開発者が VS Code 上で RPG/CL ソースを編集している  
   **When** F4 プロンプターやなど、ローカル編集支援機能のみを利用する  
   **Then** AS400 環境に対するリモート操作が自動的に行われることはなく、誤って本番環境に影響を与える心配がない。

---

### Edge Cases

- 固定長フォーマットでない RPG（フリーフォーマット）が含まれているファイルを開いた場合、  
  ツールは対象外であることを明確に知らせ、誤ったハイライトや自動整形を行わない。
- 極端に長い行数またはファイルサイズの RPG/CL ソースを開いた場合でも、  
  エディタが実用的なレスポンス（タイピングに対して体感できる大きな遅延が発生しない程度）を維持する。
- 文字コードや改行コードが想定外である RPG/CL ファイルを開いた場合、  
  ツールは安全に読み込み失敗または変換を行い、データ破損を招かないようにしたうえで、  
  ユーザーへ明確なメッセージを表示する。
- AS400 との連携機能が有効な場合、接続情報が不完全または無効なときには、  
  エラー内容と必要な設定手順を分かりやすく案内し、ソースコード自体には影響を与えない。

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-034**: ツールが RPG/CL 開発支援機能を有効にする対象ファイルは、拡張子が `.rpgle` の RPG ソースファイルおよび拡張子が `.clp` の CL ソースファイルに限定し、それ以外の拡張子のファイルは RPG/CL 支援の対象外として扱わなければならない。
- **FR-001**: ツールは RPG（ILE RPG 固定長フォーマット）および CL のソースファイルを識別し、それぞれに適した表示・支援機能を提供しなければならない。
- **FR-002**: ツールは固定長フォーマット RPG の列位置（例：仕様コード、演算子、フィールド名など）を視覚的に把握しやすい形で表示し、入力時にも列ずれが起きにくいよう支援しなければならない。
- **FR-003**: ツールは RPG 固定長フォーマットおよび CL 構文について、保存時またはユーザーが明示的に実行したときに構文チェックを行い、問題のある行と内容を示したメッセージとして表示しなければならない。
- **FR-006**: ツールは RPG ソース内でフリーフォーマット構文が検出された場合、その範囲がサポート対象外であることを示し、少なくとも固定長部の表示・支援には悪影響を与えないようにしなければならない。
- **FR-010**: F4 キーによるプロンプター起動の対象コマンドは、明示的な設定または定義済みのコマンド一覧に基づいて決定され、UI は VS Code の標準的なダイアログとして表示されなければならない。
- **FR-011**: 開発者が RPG または CL のソースコード上でカーソルをコマンドや仕様位置に置いた状態で F4 キーを押下した場合、その位置に対応する定義情報がプロンプター画面に反映され、利用者は VS Code 上でパラメータを入力できなければならない。
- **FR-012**: プロンプター画面で入力されたパラメータは、確定操作時に RPG/CL ソース内の適切な位置に挿入または更新され、固定長フォーマットの列位置が崩れないように整形されなければならない。
- **FR-013**: プロンプターは必須パラメータが未入力の場合、保存や確定時に分かりやすいエラー表示を行い、不完全なコマンドが挿入されないようにしなければならない。
- **FR-014**: ツールは RPG/CL 用の JSON 定義ファイルからプロンプター設定を読み込み、コマンドやパラメータの説明、入力タイプ、制約などを動的に構成できなければならない。
- **FR-015**: JSON 定義ファイルの読み込みエラーや構文エラーが発生した場合、ツールは安全にフォールバックし、少なくとも VS Code 側の編集機能には影響を与えないようにしなければならない。
- **FR-016**: ツールは RPG/CL ソースに対して、Ctrl+/ キー操作で現在のカーソル行または選択行をコメントアウト／コメント解除できる機能を提供しなければならない。
- **FR-017**: CL コマンドについては、行末に `+` が付与された行によって改行された複数行のコマンドを 1 つの論理コマンドとして扱い、プロンプター起動・コメントアウト／コメント解除などの機能が継続行全体に対して一貫して動作しなければならない。
- **FR-019**: ツールはワークスペース設定やユーザー設定から、構文チェックの厳しさや対象ルールを調整できるようにしなければならない。
- **FR-021**: 選択 UI は、RPG と CL のを区別して表示し、用途やパターン（例：バッチ、インタラクティブ）を説明するラベルを含まなければならない。
- **FR-022**: ツールは、RPG/CL の構文エラーを含むテスト用ソースに対して、行位置を特定したエラーメッセージを提示できなければならない。
- **FR-023**: ツールは、RPG/CL 向けの補完やスニペットを提供する場合、それらが固定長フォーマットおよび CL 構文と矛盾しない形で展開されなければならない。
- **FR-024**: ツールは、RPG/CL ソース内での検索・置換操作において、固定長フォーマットの列構造が大きく乱れないようなガイドや注意喚起を提供することが望ましい。
- **FR-028**: ツールは、RPG/CL 向けの主要な操作（ファイルを開く、から作成する、F4 プロンプターを起動するなど）について、Quick Start ガイドやヘルプへの導線を提供しなければならない。
- **FR-029**: ツールは、拡張機能が無効になっている状態でも既存の VS Code 機能に悪影響を与えず、安全にオン／オフを切り替えられなければならない。
- **FR-030**: 非表示に設定されたパラメータであっても、すでに入力値が存在する場合には、そのパラメータは非表示にできず、ユーザーが入力内容を確認・編集できるよう表示された状態を維持しなければならない。
- **FR-031**: RPG 固定長フォーマットの 4 行目には EBCDIC 等で扱われる制御情報が含まれる可能性があるため、拡張機能が行う自動整形・補助編集およびプロンプターからの挿入などの編集支援は、7 桁目以降のみを対象とし、1〜6 桁目は変更しないものとする。

---

### Key Entities *(include if feature involves data)*

- **RPG/CL ソースファイル**:  
  RPG（固定長フォーマット）および CL のプログラム本体を表す。  
  ファイル名、種別（RPG/CL）、文字コード、行ごとの内容などを持つ。

- **ワークスペース／プロジェクト**:  
  開発者が VS Code 上で開いている RPG/CL 関連ファイルの集合を表す。  
  共通の設定（構文チェックレベル、の既定値など）を持つ。

- **構文チェック結果**:  
  各位置に対するエラー・警告とメッセージ内容を表す。  
  ユーザー表示用のテキストと、どの行・列に対応するかといった位置情報を持つ。

---

### JSON Definition Requirements

- RPG の仕様に相当する定義と CL のコマンド定義は、それぞれ別の JSON ファイルとして管理しなければならない。
- グループ化されたパラメータは、JSON 上のネスト構造で親パラメータの下に子パラメータを持つ形で表現しなければならない。
- すべての JSON 定義ファイルは UTF-8 エンコーディングで保存しなければならない。
- JSON 定義ファイルの構造には、少なくとも以下の要素が含まれていなければならない。
  - キーワード名（例：RPG の仕様キーワード、CL コマンド名など）
  - キーワードの説明（ヘルプ表示用のテキスト）
  - パラメータ一覧（配列）
    - パラメータ名
    - パラメータの説明（ヘルプ表示用のテキスト）
    - 入力エリアのタイプ（テキスト、ドロップダウンなど）
    - 必須入力フラグ
    - デフォルト値
    - 属性（文字種制約、数値／文字の種別、必須／任意など）
    - 桁数や最大桁数などの長さ制約
    - プレースホルダー（入力例やヒント）
    - 最大パラメータ数（複数値を指定できる場合、0 のときは複数値指定可と解釈する等のルール）
    - ドロップダウンリストの選択肢（該当する場合）
    - ネストされたパラメータ（グループ化されたパラメータの場合に、子パラメータの配列として定義）

---

## Success Criteria *(mandatory)*
