# Phase 0 Research – RPG/CL Development Support Tool for VS Code

**Branch**: `001-rpg-cl-vscode-support`  
**Spec**: `specs/001-rpg-cl-vscode-support/spec.md`  
**Plan**: `specs/001-rpg-cl-vscode-support/plan.md`

## Unknowns & Clarifications

From the feature spec and plan,主な「NEEDS CLARIFICATION」は次の通り。

1. 初期リリースでの IBM i / AS400 連携範囲（ローカル編集のみか、ソース送信・コンパイルまで含めるか）。  
2. デバッグ支援の範囲（コンパイルエラーのみ／ログ閲覧／ブレークポイント等の実行時デバッグを含めるか）。  
3. テスト手法（どのテストフレームワークで VS Code 拡張を検証するか）。

以下では、それぞれについて調査と設計上の判断を整理する。

---

## Decision 1: IBM i / AS400 連携範囲（初期リリース）

**Decision**: 初期リリースでは「ローカル編集支援＋必要最小限の一方向連携（任意）」に留める。  
具体的には VS Code 上での RPG/CL 編集支援とプロンプター機能を主とし、IBM i への直接コマンド実行や本格的なデプロイ／同期機能は後続フェーズで検討する。

**Rationale**:
- 憲法の Principle 1 に従い、安全性を最優先するため。  
- 現時点のユーザーストーリーの中心は「VS Code 上での編集体験の改善」であり、IBM i 側のオブジェクト管理や運用フローとの統合はスコープを大きく押し広げる。  
- IBM i 側の権限や環境差異（開発／検証／本番）を考慮すると、初期リリースでの連携機能は運用設計とセキュリティレビューの負荷が大きい。

**Alternatives considered**:
- **A. ローカル編集支援のみ（連携なし）**  
  - 最も安全だが、「VS Code から最低限の実行・コンパイルをしたい」という期待に対する余地がない。  
- **B. 一方向の送信とコンパイル実行まで含める**  
  - 実務的な価値は高いが、接続情報や権限の扱い、ログ取得などの設計が必要。  
- **C. ソース同期やジョブ管理まで含む広範な連携**  
  - 初期リリースとしてはスコープが大きく、安全な設計・実装・検証の負荷が高すぎる。

**Resolution for plan**:
- plan.md および今後の tasks では、ローカル編集支援を P1/P2 の主対象とし、IBM i 連携に関する項目は「将来のフェーズで拡張可能な設計」として抽象化する。  
- spec 上の [NEEDS CLARIFICATION] は、初期版では「ローカル編集中心・IBM i への直接実行は行わない（あるいは試験的な一方向送信に限定）」という方針を前提に読み替える。

---

## Decision 2: デバッグ支援の範囲

**Decision**: 初期リリースでは「コンパイルエラーおよび静的な構文チェック結果の表示」に限定し、実行時デバッグ（ブレークポイント・ステップ実行・変数ウォッチ）は対象外とする。

**Rationale**:
- 実行時デバッグを VS Code から提供するには IBM i 上のデバッガとの連携、セッション管理、権限設定などが必要であり、初期リリースのスコープを大きく超える。  
- 一方で、構文エラーと固定長フォーマットに特有のミス（列位置、桁数、文字種）を早期に検出・可視化するだけでも、開発者体験の改善効果は高い。  
- 将来、実行時デバッグを拡張する場合でも、現在の構文チェック・エラー表示の仕組みはそのまま活用できる。

**Alternatives considered**:
- **A. コンパイルエラーのみ表示**  
  - シンプルだが、ローカルでできる静的検証を活用しきれない。  
- **B. コンパイルエラー＋ジョブログ閲覧**  
  - 有用だが、IBM i とのオンライン連携が前提になり、Decision 1 の方針と連動して複雑化する。  
- **C. フルデバッグ（ブレークポイント、ステップ実行等）**  
  - 高い価値があるが、初期フェーズとしては過大な投資とリスク。

**Resolution for plan**:
- plan.md / data-model.md / contracts では、構文チェック結果とエラー表示のモデルおよびワークフローを中心に設計する。  
- 将来的なジョブログ連携やデバッグ拡張を見越して、エラー・警告メッセージは汎用的な「診断結果」として扱う。

---

## Decision 3: テスト方針（VS Code 拡張の検証）

**Decision**: テストフレームワークとしては VS Code 拡張の標準的な組み合わせ（`vscode-test` + Mocha）を前提としつつ、初期段階では以下の方針で段階的に導入する。

1. コアロジック（JSON定義の読み込み・検証、プロンプターのパラメータ構築）の単体テスト。  
2. 主要シナリオ（RPG/CLファイルを開く、F4プロンプターを起動する）の最小限の統合テスト。  
3. IBM i 連携が追加される場合は、開発／検証環境に対する接続部分のみを対象とした統合テストまたはモックベースの検証を追加。

**Rationale**:
- 憲法によりテストは必須ではないが、RPG/CL 固有ロジックと JSON 定義の整合性は自動テストで守った方が安全。  
- VS Code 拡張の一般的なベストプラクティスに従うことで、将来的なメンテナンスや外部コントリビューションが容易になる。

**Alternatives considered**:
- **A. 手動テストのみ**  
  - 初期コストは低いが、JSON定義が増えるほどリグレッションリスクが増大する。  
- **B. 完全自動テスト（全ユーザーストーリーを自動化）**  
  - 理想的だが、初期の機能開発スピードとのトレードオフが大きい。  
- **C. コアロジックのみ単体テスト**  
  - ある程度有効だが、F4プロンプターなど VS Code 特有の統合パスの品質保証が不十分。

**Resolution for plan**:
- plan.md の Technical Context に「Testing: vscode-test + Mocha（想定）」を採用する前提で記載し、tasks.md で最低限のテスト作成タスクをストーリーごとに紐付ける（テストの詳細は次フェーズで具体化）。

---

## Consolidated Outcomes

**IBM i 連携範囲**: 初期リリースではローカル編集支援が中心であり、IBM i への直接コマンド実行や本格的な同期はスコープ外（将来拡張候補）。  
**デバッグ範囲**: 構文チェックとエラーメッセージの可視化に限定し、実行時デバッグは対象外。  
**テスト方針**: `vscode-test` + Mocha ベースの単体・統合テストを段階的に導入する。

これらの決定により、spec 上の主要な [NEEDS CLARIFICATION] は設計上の前提として解消され、Phase 1 の data-model / contracts / quickstart 設計に進む準備が整った。

